{% extends "home.html" %}

{% block body %}
<section class="py-5">
    <div class="row mb-4">
        <div class="col-lg-8 mb-4 mb-lg-0">
            <div class="card">
                <div class="card-header">
                    <h2 class="h6 mb-0 text-uppercase">Producción por hora: Schlatter 4</h2>
                </div>
                <div class="card-body">
                    <div class="chart-holder mt-5 mb-5">
                        <canvas id="PPH" style="height: 370px; width: 100%;"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card mb-4" style="height: 250px;">
                <div class="card-header">
                    <h2 class="h6 text-uppercase mb-0">Producción deseada</h2>
                </div>
                <div class="card-body" style="text-align:center">
                    <p class="mb-5 text-gray" style="margin-bottom: 0px;">Ingresar la meta de golpes por hora: </p>
                    <input type="number" class="form-control" id="goal" placeholder="Golpes por hora" style="position: relative; top:-20%; margin-top: -30px;">
                    <button onclick="graphLine()" class="btn btn-primary" style="color:lightgray; border-color: lightgray; background-color: #3A3A3C; border-width: 2px; position: relative; margin-top: 15px;">Graficar</button>
                </div>
            </div>
            <div class="card mb-3" style="height: 150px;">
                <div class="card-header">
                    <h2 class="h6 text-uppercase mb-0">Número de paros</h2>
                </div>
                <div class="card-body" style="text-align: center;">
                    <label id="stops" style="font-size: 30px; margin-top: -12px;
                    margin-bottom: 0px;"><b>0</b></label>
                </div>
            </div>
            <div class="card mb-3" style="height: 150px;">
                <div class="card-header">
                    <h2 class="h6 text-uppercase mb-0">Últimpo paro</h2>
                </div>
                <div class="card-body" style="text-align: center;">
                    <label id="last_stop" style="font-size: 15px; margin-top: -12px;
                        margin-bottom: 0px;">No ha iniciado la máquina</label>
                </div>
            </div>
        </div>
    </div>
    <div class="row mb-4">
        <div class="col-lg-4">
            <div class="card mb-4">
                <div class="card-header">
                    <h2 class="h6 text-uppercase mb-0">Hora de inicio</h2>
                </div>
                <div class="card-body" style="text-align:center;">
                    <label id="start_time" style="font-size: 30px; margin-top: -12px;
                        margin-bottom: 0px;"></label>
                </div>
            </div>
            <div class="card mb-4">
                <div class="card-header">
                    <h2 class="h6 text-uppercase mb-0">Tiempo en paro</h2>
                </div>
                <div class="card-body" style="text-align:center;">
                    <p id="hours" style="font-size: 35px; margin-top: -25px;
                        margin-bottom: 10px;"><b></b></p>
                    <p id="minutes" style="font-size: 20px;
                    margin-bottom: 10px;"><b></b></p>
                    <p id="seconds" style="font-size: 13px;
                    margin-bottom: 0px;"><b></b></p>
                </div>
            </div>
        </div>
        <div class="col-lg-8">
            <div class="card" style="height: 460px">
                <div class="card-header">
                    <h2 class="h6 text-uppercase mb-0">Gráfica de velocidad</h2>
                </div>
                <div class="card-body">
                    <label class="mb-5 text-gray">Se muestran los datos de velocidad de los últimos 7 minutos</label>
                    <canvas id="Velocities" style="height: 355px; width: 100%;  position:absolute; top:27%;"></canvas>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}
{% block script %}
<script src="{{ url_for('static', filename='js/Chart.js') }}"></script>
<script src="{{ url_for('static', filename='js/chartjs-plugin-annotation.js') }}"></script>
<script>
    var chartPPH;
    var chartVel;
    var lineValue = 0;
    var StopState;
    var labels;
    window.onload = function () {
        var date = new Date();
        var utcDate = new Date(date.toUTCString());
        hour = utcDate.getHours();
        minute = utcDate.getMinutes();
        week_day = utcDate.getDay();
        if (7 <= hour && hour <= 17) {
            if (week_day == 6){
                labels = ["7:30 - 8:30", "8:30 - 9:30", "9:30 - 10:30", "10:30 - 11:30", "11:30 - 12:30", "12:30 - 13:30"];
            }
            else{
                if ((hour == 7 && minute < 30) || (hour == 17 && minute > 30)) {
                    labels = ["21:30 - 22:30", "22:30 - 23:30", "23:30 - 00:30", "00:30 - 1:30", "1:30 - 2:30", "2:30 - 3:30", "3:30 - 4:30", "4:30 - 5:30", "5:30 - 6:30", "6:30 - 7:30"];
                }
                else {
                    labels = ["7:30 - 8:30", "8:30 - 9:30", "9:30 - 10:30", "10:30 - 11:30", "11:30 - 12:30", "12:30 - 13:30", "13:30 - 14:30", "14:30 - 15:30", "15:30 - 16:30", "16:30 - 17:30"];
                }
            }
        }
        else {
            var labels = ["21:30 - 22:30", "22:30 - 23:30", "23:30 - 00:30", "00:30 - 1:30", "1:30 - 2:30", "2:30 - 3:30", "3:30 - 4:30", "4:30 - 5:30", "5:30 - 6:30", "6:30 - 7:30"];
        }
        var hits = [0, 0, 0, 0, 0, 0, 0, 0, 0];
        var velocities = [0];
        var timeline = [0];
        var c1 = document.getElementById("PPH").getContext('2d');
        var c2 = document.getElementById("Velocities").getContext('2d');

        chartPPH = new Chart(c1, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Golpes',
                    data: hits,
                    backgroundColor: [
                        'rgba(255, 99, 132, 0.2)',
                        'rgba(54, 162, 235, 0.2)',
                        'rgba(255, 206, 86, 0.2)',
                        'rgba(75, 192, 192, 0.2)',
                        'rgba(153, 102, 255, 0.2)',
                        'rgba(255, 159, 64, 0.2)',
                        'rgba(255, 99, 132, 0.2)',
                        'rgba(54, 162, 235, 0.2)',
                        'rgba(255, 206, 86, 0.2)',
                        'rgba(75, 192, 192, 0.2)'
                    ],
                    borderColor: [
                        'rgba(255,99,132,1)',
                        'rgba(54, 162, 235, 1)',
                        'rgba(255, 206, 86, 1)',
                        'rgba(75, 192, 192, 1)',
                        'rgba(153, 102, 255, 1)',
                        'rgba(255, 159, 64, 1)',
                        'rgba(255,99,132,1)',
                        'rgba(54, 162, 235, 1)',
                        'rgba(255, 206, 86, 1)',
                        'rgba(75, 192, 192, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                legend: {
                    display: true,
                    labels: {
                        boxWidth: 0
                    }
                },
                scales: {
                    yAxes: [{
                        ticks: {
                            beginAtZero: true,
                            max: 6000
                        }
                    }]
                },
                annotation: {
                    annotations: [{
                        type: 'line',
                        mode: 'horizontal',
                        scaleID: 'y-axis-0',
                        value: lineValue,
                        borderColor: 'tomato',
                        borderWidth: 2
                    }],
                    drawTime: "afterDraw" // (default)
                }
            }
        });
        chartVel = new Chart(c2, {
            type: 'line',
            data: {
                labels: timeline,
                datasets: [{
                    label: 'Golpes por minuto',
                    data: velocities,
                    backgroundColor: 'rgba(144, 238, 144, 0.4)'
                }]
            },
            options: {
                scales: {
                    xAxes: [{
                        ticks: {
                            autoSkip: true,
                            maxTicksLimit: 6
                        }
                    }],
                    yAxes: [{
                        stacked: true,
                        ticks: {
                            beginAtZero: true,
                            max: 120
                        }
                    }]
                },
                elements: { point: { radius: .5 } }
            }
        });

        var socket = io.connect('http://' + document.domain + ':' + location.port);
        socket.on('connect', function () {
            setInterval(update, 1500);
            setInterval(updateVel, 3000);
        });
        function update() {
            socket.emit('getData'); socket.emit('getVelocities');
        }
        function updateVel() {
            socket.emit('getVelocities');
        }
        socket.on('new_data', function (new_data) {
            var json = JSON.parse(new_data);
            var start_time = json['Schlatter4']['start_time'];
            var stop_time = json['Schlatter4']['stop_time'];
            var stops = json['Schlatter4']['stops'];
            var array = [json['Schlatter4']['hour0'], json['Schlatter4']['hour1'], json['Schlatter4']['hour2'], json['Schlatter4']['hour3'], json['Schlatter4']['hour4'], json['Schlatter4']['hour5'], json['Schlatter4']['hour6'], json['Schlatter4']['hour7'], json['Schlatter4']['hour8'], json['Schlatter4']['hour9']];
            data = getDifference(array);
            chartPPH.data.datasets[0].data = data;
            chartPPH.update();
            if(Number.isInteger(stops)){
                document.querySelector("#stops").innerHTML = stops;
            }
            if(start_time == "None"){
                document.querySelector("#start_time").innerHTML = "No ha iniciado la máquina";
            }
            else{
                document.querySelector("#start_time").innerHTML = start_time;
            }
            if(stop_time == "None"){
                document.querySelector("#hours").innerHTML = "0  hora(s)";
                document.querySelector("#minutes").innerHTML = "0  minutos(s)";
                document.querySelector("#seconds").innerHTML = "0  segundos(s)";
            }
            else{
                document.querySelector("#hours").innerHTML = (String(stop_time.slice(0, 2)) + "  hora(s)");
                document.querySelector("#minutes").innerHTML = (String(stop_time.slice(3, 5)) + "  minutos(s)");
                document.querySelector("#seconds").innerHTML = (String(stop_time.slice(6, 8)) + "  segundos(s)");                
            }
        });
        socket.on('new_velocities', function (new_velocities) {
            var json_vel = JSON.parse(new_velocities);
            timeline = [];
            velocities = [];
            for (var k in json_vel) {
                timeline.push(json_vel[k].timestamp);
                velocities.push(json_vel[k].schl4);
            }
            chartVel.data.labels = timeline.slice(-80);
            chartVel.data.datasets[0].data = velocities.slice(-80);
            chartVel.update();
            if (velocities.slice(-1) != 0) {
                StopState = false;
            }
            if (velocities.slice(-1) == 0 && StopState == false) {
                StopState = true;
                var date = new Date();
                var utcDate = new Date(date.toUTCString());
                hour = String(utcDate.getHours());
                minute = String(utcDate.getMinutes());
                second = String(utcDate.getSeconds());
                last_stop_time = hour + ':' + minute + ':' + second
                document.querySelector("#last_stop").innerHTML = last_stop_time;
            }
        });
    }
    function getDifference(array) {
        var data = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
        for (i = 0; i < array.length; i++) {
            if (i == 0) {
                data[i] = array[i];
            }
            else if (array[i] != 0) {
                data[i] = array[i] - array[i - 1];
            }
        }
        return data;
    }
    function graphLine() {
        lineValue = document.getElementById('goal').value;
        chartPPH.options.annotation.annotations[0].value = lineValue;
        chartPPH.update();
    }
</script>
{% endblock %}