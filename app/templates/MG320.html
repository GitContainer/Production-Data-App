{% extends "home.html" %}

{% block body %}
<section class="py-5">
    <div class="row mb-4">
        <div class="col-lg-8 mb-4 mb-lg-0">
            <div class="card">
                <div class="card-header">
                    <h2 class="h6 mb-0 text-uppercase">Producción por hora: MG320</h2>
                </div>
                <div class="card-body">
                    <div class="chart-holder mt-5 mb-5">
                        <canvas id="PPH" style="height: 370px; width: 100%;"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card mb-4" style="height: 285px;">
                <div class="card-header">
                    <h2 class="h6 text-uppercase mb-0">Producción deseada</h2>
                </div>
                <div class="card-body">
                    <p class="mb-5 text-gray">Ingresar la meta de golpes por hora: </p>
                    <div class="chart-holder" style="text-align:center;">
                        <form>
                            <div class="form-group">
                                <input type="number" class="form-control" id="goal" placeholder="Golpes por hora">
                            </div>
                        </form>
                        <button onclick="graphLine()" class="btn btn-primary" style="color:lightgray; border-color: lightgray; background-color: #3A3A3C; border-width: 2px">Graficar</button>
                    </div>
                </div>
            </div>
            <div class="card mb-3">
                <div class="card-header">
                    <h2 class="h6 text-uppercase mb-0">Número de paros</h2>
                </div>
                <div class="card-body">
                    <div class="chart-holder">
                        <canvas id="barChartExample"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="row mb-4">
        <div class="col-lg-4">
            <div class="card mb-4">
                <div class="card-header">
                    <h2 class="h6 text-uppercase mb-0">Hora de inicio</h2>
                </div>
                <div class="card-body">
                    <div class="chart-holder">
                        <canvas id="pieChart1"></canvas>
                    </div>
                </div>
            </div>
            <div class="card mb-4">
                <div class="card-header">
                    <h2 class="h6 text-uppercase mb-0">Tiempo en paro</h2>
                </div>
                <div class="card-body">
                    <div class="chart-holder">
                        <canvas id="pieChart2"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h2 class="h6 text-uppercase mb-0">Gráfica de velocidad</h2>
                </div>
                <div class="card-body">
                    <div class="chart-holder mt-5 mb-5">
                        <canvas id="lineChartExample"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}
{% block script %}
<script src="{{ url_for('static', filename='js/Chart.js') }}"></script>
<script src="{{ url_for('static', filename='js/chartjs-plugin-annotation.js') }}"></script>
<script>
    var chartPPH;
    var lineValue = 0;
    window.onload = function () {
        var date = new Date();
        var utcDate = new Date(date.toUTCString());
        hour = utcDate.getHours();
        minute = utcDate.getMinutes();
        if (7 <= hour && hour <= 17) {
            if ((hour == 7 && minute < 30) || (hour == 17 && minute > 30)) {
                var labels = ["21:30 - 22:30", "22:30 - 23:30", "23:30 - 00:30", "00:30 - 1:30", "1:30 - 2:30", "2:30 - 3:30", "3:30 - 4:30", "4:30 - 5:30", "5:30 - 6:30", "6:30 - 7:30"];
            }
            else {
                var labels = ["7:30 - 8:30", "8:30 - 9:30", "9:30 - 10:30", "10:30 - 11:30", "11:30 - 12:30", "12:30 - 13:30", "13:30 - 14:30", "14:30 - 15:30", "15:30 - 16:30", "16:30 - 17:30"];
            }
        }
        else {
            var labels = ["21:30 - 22:30", "22:30 - 23:30", "23:30 - 00:30", "00:30 - 1:30", "1:30 - 2:30", "2:30 - 3:30", "3:30 - 4:30", "4:30 - 5:30", "5:30 - 6:30", "6:30 - 7:30"];
        } 
        var hits = [0, 0, 0, 0, 0, 0, 0, 0, 0];
        var c1 = document.getElementById("PPH").getContext('2d');
        chartPPH = new Chart(c1, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Golpes',
                    data: hits,
                    backgroundColor: [
                        'rgba(255, 99, 132, 0.2)',
                        'rgba(54, 162, 235, 0.2)',
                        'rgba(255, 206, 86, 0.2)',
                        'rgba(75, 192, 192, 0.2)',
                        'rgba(153, 102, 255, 0.2)',
                        'rgba(255, 159, 64, 0.2)',
                        'rgba(255, 99, 132, 0.2)',
                        'rgba(54, 162, 235, 0.2)',
                        'rgba(255, 206, 86, 0.2)',
                        'rgba(75, 192, 192, 0.2)'
                    ],
                    borderColor: [
                        'rgba(255,99,132,1)',
                        'rgba(54, 162, 235, 1)',
                        'rgba(255, 206, 86, 1)',
                        'rgba(75, 192, 192, 1)',
                        'rgba(153, 102, 255, 1)',
                        'rgba(255, 159, 64, 1)',
                        'rgba(255,99,132,1)',
                        'rgba(54, 162, 235, 1)',
                        'rgba(255, 206, 86, 1)',
                        'rgba(75, 192, 192, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                legend: {
                    display: true,
                    labels: {
                        boxWidth: 0
                    }
                },
                scales: {
                    yAxes: [{
                        ticks: {
                            beginAtZero: true,
                            max: 12000
                        }
                    }]
                },
                annotation: {
                    annotations: [{
                        type: 'line',
                        mode: 'horizontal',
                        scaleID: 'y-axis-0',
                        value: lineValue,
                        borderColor: 'tomato',
                        borderWidth: 2
                    }],
                    drawTime: "afterDraw" // (default)
                }
            }
        });
        var socket = io.connect('http://' + document.domain + ':' + location.port);
        socket.on('connect', function () {
            setInterval(update, 1500);
        });
        function update() {
            socket.emit('getData');
        }
        socket.on('new_data', function (new_data) {
            var json = JSON.parse(new_data);
            var start_time = json['MG320']['start_time'];
            var stop_time = json['MG320']['stop_time'];
            var stops = json['MG320']['stops'];
            var array = [json['MG320']['hour0'], json['MG320']['hour1'], json['MG320']['hour2'], json['MG320']['hour3'], json['MG320']['hour4'], json['MG320']['hour5'], json['MG320']['hour6'], json['MG320']['hour7'], json['MG320']['hour8'], json['MG320']['hour9']];
            data = getDifference(array);
            chartPPH.data.datasets[0].data = data;
            chartPPH.update()
        });
    }
    function getDifference(array) {
        var data = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
        for (i = 0; i < array.length; i++) {
            if(i == 0){
                data[i] = array[i];
            }
            else if(array[i] != 0){
                data[i] = array[i] - array[i-1];
            }
        }
        return data;
    }
    function graphLine() {
        lineValue = document.getElementById('goal').value;
        chartPPH.options.annotation.annotations[0].value = lineValue;
        chartPPH.update();
    }
</script>
{% endblock %}